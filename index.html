<!DOCTYPE html>
<html>
  <head>
    <base href="/" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/paymob-pixel@latest/styles.css"
    />
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/paymob-pixel@latest/main.css"
    />
    <script
      src="https://cdn.jsdelivr.net/npm/paymob-pixel@latest/main.js"
      type="module"
    ></script>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script>

    <style>
      html,
      body {
        font: 14px 'Lucida Grande', Helvetica, Arial, sans-serif;
        height: 100%;
        overflow: auto;
        background-color: #fdfdf6;
      }
      #paymob {
        background-color: #fdfdf6;
        padding: 16px;
      }
      #payFromOutsideButton {
        padding: 16px;
        background: #2b772b;
        color: white;
        border-radius: 25px;
        height: 50px;
        width: calc(100% - 32px);
        display: block;
        margin: auto;
      }
      #payFromOutsideButton:hover,
      #payFromOutsideButton:focus {
        background-color: #0e3b0e;
      }
      #paymob img[class*='copyrights_logo'],
      #paymob img[alt='paymob'] {
        display: none !important;
      }

      /* üîç On-screen debug console */
      #debugConsole {
        position: fixed;
        bottom: 0;
        left: 0;
        width: 100%;
        max-height: 200px;
        overflow-y: auto;
        background: rgba(0, 0, 0, 0.85);
        color: #0f0;
        font-size: 12px;
        padding: 6px;
        z-index: 99999;
        font-family: monospace;
      }
    </style>
  </head>
  <body>
    <div id="container">
      <div id="content">
        <div id="paymob"></div>
        <button id="payFromOutsideButton"><p id="payText"></p></button>
      </div>
    </div>

    <script>
      const ENCRYPTION_KEY = 'GIVERS_AES_KEY'; // ‚úÖ Store in env variable, not in code

      // üß† Parse cookies into an object
      function parseCookies() {
        return document.cookie.split(';').reduce((acc, cookie) => {
          const [key, value] = cookie.trim().split('=');
          if (key && value) acc[key] = decodeURIComponent(value);
          return acc;
        }, {});
      }

      console.log('CryptoJS', CryptoJS.AES);

      // On the web:
      function decryptToken(encrypted) {
        console.log('value to decrypt', encrypted);
        try {
          const bytes = CryptoJS.AES.decrypt(encrypted, ENCRYPTION_KEY);
          return bytes.toString(CryptoJS.enc.Utf8);
        } catch (e) {
          console.log('‚ùå Failed to decrypt token', JSON.stringify(e));
          return null;
        }
      }
      
      // üß† Helper: get a config value from cookies, window, or query params
      function getConfigValue(key, defaultValue = null) {
        const cookies = parseCookies();
        if (cookies[key]) return cookies[key]; // ‚úÖ Prefer cookies
        if (typeof window[key] !== 'undefined') return window[key]; // ‚úÖ Then window
        const params = new URLSearchParams(window.location.search);
        return params.get(key) || defaultValue; // ‚úÖ Fallback to query params
      }

      window.onload = function () {
        const payButton = document.getElementById('payFromOutsideButton');
        const payText = document.getElementById('payText');

        // ‚úÖ Read config from cookies, JS, or query params
        const paymentFlowType = getConfigValue('paymentFlowType', 'Pay');
        const language = getConfigValue('language', 'en');
        const publicKey = getConfigValue('publicKey');
        const secretKey = getConfigValue('token') || decryptToken(getConfigValue('encryptedToken'));

        if (secretKey) {
          alert(secretKey)
        }

        if (!publicKey || !secretKey) {
          return;
        }

        if (paymentFlowType === 'SaveCard') {
          payText.innerText = language === 'en' ? 'Save card' : 'ÿ≠ŸÅÿ∏';
        } else {
          payText.innerText = language === 'en' ? 'Pay' : 'ÿØŸÅÿπ';
        }

        payButton.disabled = true;
        payButton.style.opacity = '0.6';
        payButton.style.cursor = 'not-allowed';

        // ‚úÖ Initialize Paymob Pixel
        new Pixel({
          publicKey,
          clientSecret: secretKey,
          paymentMethods: ['card'],
          elementId: 'paymob',
          disablePay: true,
          forceSaveCard: paymentFlowType === 'SaveCard',
          showSaveCard: paymentFlowType !== 'SaveCard',
          afterPaymentComplete: async (response) => {
            console.log('üí≥ Payment complete', response);
            if (window.ReactNativeWebView) {
              window.ReactNativeWebView.postMessage(
                JSON.stringify({ afterPaymentComplete: response })
              );
            }
          },
          cardValidationChanged: (isValid) => {
            payButton.disabled = !isValid;
            payButton.style.opacity = isValid ? '1' : '0.6';
            payButton.style.cursor = isValid ? 'pointer' : 'not-allowed';
          },
          customStyle: {
            Font_Family: 'Gotham',
            Font_Size_Label: '16',
            Font_Size_Input_Fields: '16',
            Font_Size_Payment_Button: '14',
            Font_Weight_Label: 400,
            Font_Weight_Input_Fields: 200,
            Font_Weight_Payment_Button: 600,
            Color_Container: '#FDFDF6',
            Color_Border_Input_Fields: '#D0D5DD',
            Color_Primary: '#2B772B',
            Color_Disabled: '#A1B8FF',
            Color_Error: '#CC1142',
            Color_Input_Fields: '#FFF',
            Text_Color_For_Label: '#000',
            Text_Color_For_Payment_Button: '#FFF',
            Text_Color_For_Input_Fields: '#000',
            Width_of_Container: '100%',
            Vertical_Padding: '40',
            ...(language === 'ar' && {
              Direction: 'rtl',
              Label_Text: { cardLabel: 'ÿ®ŸäÿßŸÜÿßÿ™ ÿßŸÑÿ®ÿ∑ÿßŸÇÿ©' },
            }),
          },
        });

        payButton.addEventListener('click', function () {
          const event = new Event('payFromOutside');
          window.dispatchEvent(event);
          payText.innerText = language === 'ar' ? 'ÿ¨ÿßÿ±Ÿä ÿßŸÑÿ™ÿ≠ŸÖŸäŸÑ' : 'Loading...';
        });

        // Hide Paymob logo dynamically
        let count = 0;
        const interval = setInterval(() => {
          const host = document.querySelector('#paymob div');
          count++;
          if (host && host.shadowRoot) {
            const images = host.shadowRoot.querySelectorAll(
              "img[class*='copyrights_logo']"
            );
            if (images.length > 0) {
              images.forEach((img) => img.parentElement?.remove());
            }
          }
          if (count >= 100) clearInterval(interval);
        }, 100);
      };
    </script>
  </body>
</html>
